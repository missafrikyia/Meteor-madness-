<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meteor Madness: Ants to the Rescue</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:Arial, sans-serif}
  #wrap{max-width:900px;margin:0 auto;padding:8px}
  canvas{width:100%;height:auto;border:2px solid #333;background:radial-gradient(circle at center,#050815 0%,#000 70%)}
  .hud{display:flex;gap:12px;margin:10px 0}
  .tag{background:#111;border:1px solid #333;border-radius:8px;padding:6px 12px}
  .btns{margin:8px 0;display:flex;gap:8px}
  button{background:#1a1f2e;color:#fff;border:1px solid #3a4a7a;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .card{margin:10px 0;padding:10px;border:1px solid #333;border-radius:10px;background:#0b0f18}
</style>
</head>
<body>
<div id="wrap">
  <h2>Meteor Madness: Ants to the Rescue üêú‚òÑÔ∏è</h2>

  <div class="hud">
    <div class="tag">‚ù§Ô∏è Vies: <span id="lives">3</span></div>
    <div class="tag">‚≠ê Score: <span id="score">0</span></div>
    <div class="tag">üåç Niveau: <span id="level">1</span></div>
  </div>

  <canvas id="game" width="800" height="500"></canvas>

  <div class="btns">
    <button id="fireBtn">Tirer üî¥ (Espace)</button>
    <button id="shieldBtn">Bouclier üõ°Ô∏è (B)</button>
    <button id="resetBtn">Rejouer ‚Üª</button>
  </div>

  <div class="card" id="fact" hidden></div>

  <div class="card">
    <b>Contr√¥les :</b> Tirer (Espace) ‚Ä¢ Bouclier (B) ‚Ä¢ Rejouer (R).  
    <br/>But : emp√™cher que l‚Äôast√©ro√Øde frappe la Terre !
  </div>

  <div class="card" id="simPanel">
    <b>Simulation NASA</b><br/>
    Taille (m): <input type="range" id="diam" min="50" max="500" value="200">
    Œîv d√©viation (mm/s): <input type="range" id="dv" min="0" max="5" step="0.1" value="1">
    <button id="applyMitigation">Tester la d√©viation</button>
    <div id="simOut"></div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const c = canvas.getContext('2d');
  const uiLives = document.getElementById('lives');
  const uiScore = document.getElementById('score');
  const uiLevel = document.getElementById('level');
  const fact = document.getElementById('fact');
  const W = canvas.width, H = canvas.height;

  // --- Earth base ---
  const earth = { x: W/2, y: H-40, r: 30 };
  let bullets=[], asteroids=[], lives=3, score=0, level=1, running=true;
  let shield = { active:false, timer:0, cooldown:0 };
  let lastTime=0, usedShieldOnce=false;

  // --- Fallback JSON int√©gr√© ---
  const NEO_FALLBACK = [
    { name: "Test-NEO-1", diameter_m: 120, velocity_kms: 18, miss_km: 750000, hazardous: false },
    { name: "Test-NEO-2", diameter_m: 320, velocity_kms: 22, miss_km: 220000, hazardous: true },
    { name: "Test-NEO-3", diameter_m: 55, velocity_kms: 12, miss_km: 50000, hazardous: false }
  ];
  window.NEO_LIST = NEO_FALLBACK;

  // --- API NASA (optionnel si connexion)
  async function loadNEOData(){
    const API_KEY="DEMO_KEY"; // Remplacer par ta cl√©
    const today=new Date().toISOString().slice(0,10);
    const url=`https://api.nasa.gov/neo/rest/v1/feed?start_date=${today}&api_key=${API_KEY}`;
    try{
      const r=await fetch(url);
      if(!r.ok) throw new Error("API NASA error");
      const data=await r.json();
      const list=[];
      for(const day of Object.values(data.near_earth_objects)){
        for(const o of day){
          const d=o.estimated_diameter.meters.estimated_diameter_max;
          const approach=o.close_approach_data?.[0];
          list.push({
            name:o.name,
            diameter_m:d,
            velocity_kms:parseFloat(approach.relative_velocity.kilometers_per_second),
            miss_km:parseFloat(approach.miss_distance.kilometers),
            hazardous:o.is_potentially_hazardous_asteroid
          });
        }
      }
      window.NEO_LIST=list;
    }catch(e){
      console.warn("NASA API down, fallback activ√©", e);
      window.NEO_LIST=NEO_FALLBACK;
    }
  }
  loadNEOData();

  // --- Core gameplay functions ---
  function showFact(t){fact.textContent=t;fact.hidden=false;setTimeout(()=>fact.hidden=true,4000);}
  function reset(){lives=3;score=0;level=1;bullets=[];asteroids=[];running=true;uiLives.textContent=lives;uiScore.textContent=score;uiLevel.textContent=level;spawnWave();}
  function fire(){if(!running)return;bullets.push({x:earth.x,y:earth.y-earth.r-4,vy:-400});}
  function activateShield(){if(shield.cooldown>0||shield.active)return;shield.active=true;shield.timer=2.0;shield.cooldown=5.0;}
  document.getElementById('fireBtn').onclick=fire;
  document.getElementById('shieldBtn').onclick=activateShield;
  document.getElementById('resetBtn').onclick=reset;
  window.addEventListener('keydown',e=>{if(e.code==="Space")fire();if(e.key.toLowerCase()==='b')activateShield();if(e.key.toLowerCase()==='r')reset();});
  canvas.addEventListener('pointerdown',fire);

  function chooseNEOforLevel(level){
    if(!window.NEO_LIST||!NEO_LIST.length) return null;
    const sorted=[...NEO_LIST].sort((a,b)=>(b.diameter_m*b.velocity_kms)-(a.diameter_m*a.velocity_kms));
    return sorted[Math.min(level-1,sorted.length-1)];
  }

  function spawnWave(){
    asteroids=[];
    const neo=chooseNEOforLevel(level);
    if(neo){
      const r=Math.min(30,Math.max(12,neo.diameter_m/20));
      asteroids.push({x:Math.random()*W,y:-100,r, hp:neo.diameter_m>250?3:neo.diameter_m>150?2:1, speed:60+Math.min(80,neo.velocity_kms*2)});
      showFact(`${neo.name} ‚Ä¢ ${neo.diameter_m|0} m ‚Ä¢ ${neo.velocity_kms.toFixed(1)} km/s`);
    }
  }

  function update(dt){
    if(shield.active){shield.timer-=dt;if(shield.timer<=0)shield.active=false;}
    else if(shield.cooldown>0){shield.cooldown-=dt;if(shield.cooldown<0)shield.cooldown=0;}
    bullets.forEach(b=>b.y+=b.vy*dt); bullets=bullets.filter(b=>b.y>-20);
    for(const a of asteroids){
      a.y+=a.speed*dt;
      for(const b of bullets){const dx=a.x-b.x,dy=a.y-b.y;if(dx*dx+dy*dy<(a.r+6)*(a.r+6)){a.hp--;b.y=-9999;}}
      const dx=a.x-earth.x,dy=a.y-earth.y;if(dx*dx+dy*dy<(a.r+earth.r)*(a.r+earth.r)){if(shield.active){a.y-=30;a.speed*=0.6;}else{lives--;uiLives.textContent=lives;a.y=H+50;}}
    }
    const before=asteroids.length;
    asteroids=asteroids.filter(a=>{if(a.hp<=0){score++;uiScore.textContent=score;return false;}return a.y<H+40;});
    if(asteroids.length===0&&before>0){level++;uiLevel.textContent=level;if(level<=3)spawnWave();else{running=false;showFact("Victoire ! üåç")}}
    if(lives<=0&&running){running=false;showFact("Game Over üí•");}
  }

  function draw(){
    c.clearRect(0,0,W,H);
    c.fillStyle="#1e9bff";c.beginPath();c.arc(earth.x,earth.y,earth.r,0,Math.PI*2);c.fill(); // Terre
    if(shield.active){c.strokeStyle="#58ffa4";c.lineWidth=4;c.beginPath();c.arc(earth.x,earth.y,earth.r+12,0,Math.PI*2);c.stroke();}
    c.fillStyle="#ff3b30";bullets.forEach(b=>c.fillRect(b.x-3,b.y-10,6,12));
    for(const a of asteroids){c.fillStyle="#a77";c.beginPath();c.arc(a.x,a.y,a.r,0,Math.PI*2);c.fill();}
  }

  function loop(ts){if(!lastTime)lastTime=ts;const dt=Math.min((ts-lastTime)/1000,0.033);lastTime=ts;update(dt);draw();if(running)requestAnimationFrame(loop);}
  reset();requestAnimationFrame(loop);

  // --- Simulation NASA (Œîv simple) ---
  document.getElementById('applyMitigation').onclick=()=>{
    const neo=chooseNEOforLevel(level);
    if(!neo)return;
    const dUser=parseFloat(document.getElementById('diam').value);
    const dv_mm_s=parseFloat(document.getElementById('dv').value);
    const T=30*24*3600; // 30 jours
    const dv_km_s=dv_mm_s/1e6;
    const extra= dv_km_s*T;
    const newMiss=neo.miss_km+extra;
    document.getElementById('simOut').textContent=
      `Nouvelle miss distance ‚âà ${newMiss.toFixed(0)} km ‚Äî ${(newMiss>0?"√âVIT√â ‚úÖ":"TOUCHE ‚ùå")}`;
  };
})();
</script>
</body>
</html>
