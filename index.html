<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meteor Madness: Ants to the Rescue</title>
<style>
  html,body{margin:0;background:#000;color:#fff;font-family:system-ui,Arial}
  #wrap{max-width:800px;margin:0 auto;padding:8px}
  canvas{width:100%;height:auto;border:2px solid #1e1e1e;background:radial-gradient(ellipse at center,#050815 0%,#000 70%)}
  .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .tag{background:#111;border:1px solid #333;border-radius:8px;padding:6px 10px}
  .btns{margin:8px 0;display:flex;gap:8px;flex-wrap:wrap}
  button{background:#1a1f2e;color:#fff;border:1px solid #3a4a7a;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .card{margin:10px 0;padding:10px;border:1px solid #333;border-radius:10px;background:#0b0f18}
</style>
</head>
<body>
<div id="wrap">
  <h2>Meteor Madness: Ants to the Rescue üêú‚òÑÔ∏è</h2>

  <div class="hud">
    <div class="tag">Vies: <span id="lives">3</span></div>
    <div class="tag">Score: <span id="score">0</span></div>
    <div class="tag">Niveau: <span id="level">1</span></div>
  </div>

  <canvas id="game" width="800" height="500"></canvas>

  <div class="btns">
    <button id="fireBtn">TIR üî¥ (Espace / Tap)</button>
    <button id="shieldBtn">Bouclier üõ°Ô∏è (B)</button>
    <button id="rocketBtn">Fus√©e üöÄ (Sp√©cial)</button>
    <button id="resetBtn">Rejouer ‚Üª</button>
  </div>

  <div class="card" id="fact" hidden></div>

  <div class="card">
    <b>Contr√¥les :</b> Espace/Tap = Tir ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Fus√©e = attaque sp√©ciale (cooldown) ‚Ä¢ √âvitez que les ast√©ro√Ødes touchent la Terre !
    <br/>Cartes NASA s‚Äôaffichent √† chaque mont√©e de niveau (Apophis, DART, Bennu).
  </div>
</div>

<script>
(() => {
  // --- CONFIG ---
  const canvas = document.getElementById('game');
  const c = canvas.getContext('2d');
  const uiLives = document.getElementById('lives');
  const uiScore = document.getElementById('score');
  const uiLevel = document.getElementById('level');
  const fact = document.getElementById('fact');

  const W = canvas.width, H = canvas.height;
  const earth = { x: W/2, y: H-40, r: 26 };

  let bullets = [];
  let asteroids = [];
  let lives = 3, score = 0, level = 1;
  let running = true;
  let shield = { active:false, timer:0, cooldown:0 }; // seconds
  let rocket = { active:false, x:0, y:0, vy:-280, cooldown:0 }; // seconds
  let lastTime = 0;
  let usedShieldOnce = false;

  const facts = {
    1: "Apophis passera tr√®s pr√®s de la Terre en 2029.",
    2: "En 2022, la mission DART a d√©vi√© l‚Äôorbite de Dimorphos.",
    3: "OSIRIS-REx a rapport√© des √©chantillons de Bennu en 2023."
  };

  function showFact(lvl){
    const txt = facts[lvl] || "";
    fact.textContent = txt;
    fact.hidden = !txt;
    setTimeout(()=>{ fact.hidden = true; }, 3000);
  }

  function reset() {
    lives = 3; score = 0; level = 1;
    bullets = []; asteroids = [];
    shield = { active:false, timer:0, cooldown:0 };
    rocket = { active:false, x:0, y:0, vy:-280, cooldown:0 };
    running = true; lastTime = 0; usedShieldOnce = false;
    uiLives.textContent = lives;
    uiScore.textContent = score;
    uiLevel.textContent = level;
    spawnWave();
    showFact(1);
  }

  // --- GAMEPLAY ---
  function spawnWave() {
    asteroids = [];
    const count = level === 1 ? 5 : (level === 2 ? 8 : 10);
    for (let i=0;i<count;i++){
      const size = level===1 ? 14 : (level===2 ? 20 : 28);
      const hp = level===1 ? 1 : (level===2 ? 2 : 3);
      asteroids.push({
        x: Math.random()*W, y: -Math.random()*H - 20,
        r: size, hp,
        speed: (level===1? 60: (level===2? 85: 110)) * (0.75 + Math.random()*0.5), // px/s
      });
    }
  }

  function fire() {
    if (!running) return;
    bullets.push({ x: earth.x, y: earth.y - earth.r - 4, vy: -500 });
  }

  function activateShield() {
    if (!running) return;
    if (shield.cooldown > 0 || shield.active) return;
    shield.active = true;
    shield.timer = 2.0;      // actif 2 s
    shield.cooldown = 5.0;   // recharge 5 s
  }

  function launchRocket(){
    if (!running) return;
    if (rocket.active || rocket.cooldown > 0) return;
    rocket.active = true;
    rocket.x = earth.x;
    rocket.y = earth.y - earth.r - 6;
    rocket.cooldown = 8; // recharge 8 s
  }

  function explodeAt(x,y){
    const R = 60; // rayon d‚Äôexplosion
    let destroyed = 0;
    asteroids = asteroids.filter(a => {
      const dx = a.x - x, dy = a.y - y;
      if (dx*dx + dy*dy <= R*R){
        a.hp -= 3; // gros d√©g√¢ts "type DART"
        if (a.hp <= 0){ score += 1; destroyed++; return false; }
      }
      return true;
    });
    uiScore.textContent = score;
    showBanner(`Impact DART üí• (${destroyed} d√©truit${destroyed>1?'s':''})`);
    setTimeout(()=>{ fact.hidden = true; }, 1000);
  }

  // --- INPUTS ---
  document.getElementById('fireBtn').onclick = fire;
  document.getElementById('shieldBtn').onclick = activateShield;
  document.getElementById('rocketBtn').onclick = launchRocket;
  document.getElementById('resetBtn').onclick = reset;

  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space') { e.preventDefault(); fire(); }
    if (e.key.toLowerCase() === 'b') { activateShield(); }
    if (e.key.toLowerCase() === 'r') { reset(); }
  });
  // Tap anywhere on canvas to fire (mobile)
  canvas.addEventListener('pointerdown', fire, {passive:true});

  // --- LOOP ---
  function loop(ts){
    if (!lastTime) lastTime = ts;
    // dt en secondes, minimum 1/60 ; clamp max
    let dt = (ts - lastTime) / 1000;
    if (dt <= 0) dt = 1/60;
    if (dt > 0.033) dt = 0.033;
    lastTime = ts;

    update(dt);
    draw();
    if (running) requestAnimationFrame(loop);
  }

  function update(dt){
    // Shield timers
    if (shield.active) {
      shield.timer -= dt;
      if (shield.timer <= 0) shield.active = false;
    } else if (shield.cooldown > 0) {
      shield.cooldown -= dt;
      if (shield.cooldown < 0) shield.cooldown = 0;
    }

    // Rocket cooldown + vol
    if (rocket.cooldown > 0) { rocket.cooldown -= dt; if (rocket.cooldown < 0) rocket.cooldown = 0; }
    if (rocket.active){
      rocket.y += rocket.vy * dt;
      // collision fus√©e/ast√©ro√Øde
      for (const a of asteroids){
        const dx = a.x - rocket.x, dy = a.y - rocket.y;
        if (dx*dx + dy*dy < (a.r+10)*(a.r+10)){
          explodeAt(rocket.x, rocket.y);
          rocket.active = false;
          break;
        }
      }
      if (rocket.y < -20){ rocket.active = false; }
    }

    // Bullets
    for (const b of bullets) {
      if (typeof b.vy !== "number") b.vy = -500;
      b.y += b.vy * dt;
    }
    bullets = bullets.filter(b => b.y > -20);

    // Asteroids
    for (const a of asteroids) {
      a.y += a.speed * dt;

      // Collision with bullets
      for (const b of bullets) {
        const dx = a.x - b.x, dy = a.y - b.y;
        if (dx*dx + dy*dy < (a.r+6)*(a.r+6)) {
          if (level < 3 || usedShieldOnce) {
            a.hp -= 1;
          }
          b.y = -9999;
        }
      }

      // Collision with earth
      const dx = a.x - earth.x, dy = a.y - earth.y;
      if (dx*dx + dy*dy < (a.r + earth.r)*(a.r + earth.r)) {
        if (shield.active) {
          a.y -= 30; a.speed *= 0.6;
        } else {
          lives -= 1;
          uiLives.textContent = lives;
          a.y = H + 50;
        }
      }
    }

    // Remove dead/out
    const before = asteroids.length;
    asteroids = asteroids.filter(a => {
      if (a.hp <= 0) { score += 1; uiScore.textContent = score; return false; }
      return a.y < H + 40;
    });

    // Win level?
    if (asteroids.length === 0 && before > 0) {
      if (level < 3) {
        level += 1;
        uiLevel.textContent = level;
        spawnWave();
        showFact(level);
        if (level === 3) usedShieldOnce = false;
      } else {
        running = false;
        showBanner("Victoire ! Fourmis gardiennes de la Terre üêúüåç");
      }
    }

    if (level === 3 && shield.active) usedShieldOnce = true;

    if (lives <= 0 && running){
      running = false;
      showBanner("Game Over üí•");
    }
  }

  function drawStars(){
    c.save();
    for (let i=0;i<80;i++){
      const x = (i*97)%W, y = (i*57)%H;
      c.fillStyle = i%7===0 ? "#99aaff" : "#5560aa";
      c.fillRect(x, y, 2, 2);
    }
    c.restore();
  }

  function draw(){
    c.clearRect(0,0,W,H);
    drawStars();

    // Earth
    c.save();
    c.beginPath();
    c.arc(earth.x, earth.y, earth.r, 0, Math.PI*2);
    c.fillStyle = "#1e9bff";
    c.fill();
    c.strokeStyle = "#0a3a66";
    c.lineWidth = 3;
    c.stroke();
    // Base fourmi (motte)
    c.fillStyle = "#6b4a2f";
    c.fillRect(earth.x-35, earth.y+earth.r-6, 70, 8);
    c.restore();

    // Shield
    if (shield.active){
      c.save();
      c.strokeStyle = "#58ffa4";
      c.lineWidth = 4;
      c.beginPath();
      c.arc(earth.x, earth.y, earth.r+12, 0, Math.PI*2);
      c.stroke();
      c.restore();
    }

    // Bullets
    c.save();
    c.fillStyle = "#ff3b30";
    bullets.forEach(b => {
      c.fillRect(b.x-3, b.y-10, 6, 12);
    });
    c.restore();

    // Rocket
    if (rocket.active){
      c.save();
      c.fillStyle = "#ffd54d";
      c.fillRect(rocket.x-4, rocket.y-10, 8, 20);  // corps
      c.fillStyle = "#ff6e40";
      c.fillRect(rocket.x-3, rocket.y+10, 6, 8);   // flamme
      c.restore();
    }
    // Indicateur cooldown fus√©e
    c.save();
    c.fillStyle = "#fff";
    c.fillText(`Fus√©e pr√™te dans: ${rocket.cooldown.toFixed(1)}s`, 10, 18);
    c.restore();

    // Asteroids
    for (const a of asteroids) {
      c.save();
      const g = c.createRadialGradient(a.x-3, a.y-3, 2, a.x, a.y, a.r);
      g.addColorStop(0,"#c7a47a");
      g.addColorStop(1,"#6b5136");
      c.fillStyle = g;
      c.beginPath();
      c.arc(a.x, a.y, a.r, 0, Math.PI*2);
      c.fill();
      // HP pips
      c.fillStyle = "#fff";
      for (let i=0;i<a.hp;i++){
        c.fillRect(a.x- a.r + 4 + i*6, a.y- a.r - 10, 4, 4);
      }
      c.restore();
    }
  }

  function showBanner(text){
    fact.textContent = text;
    fact.hidden = false;
  }

  reset();
  requestAnimationFrame(loop);
  // fallback (s√©curit√© mobile)
  setInterval(()=>{ if(running){ update(1/60); draw(); } }, 1000/60);
})();
</script>
</body>
</html>
