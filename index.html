<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meteor Madness: Ants to the Rescue</title>
<style>
  html,body{margin:0;background:#000;color:#fff;font-family:system-ui,Arial}
  #wrap{max-width:900px;margin:0 auto;padding:10px}
  canvas{width:100%;height:auto;border:2px solid #1e1e1e;background:radial-gradient(ellipse at center,#050815 0%,#000 70%)}
  .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .tag{background:#111;border:1px solid #333;border-radius:8px;padding:6px 10px;display:flex;gap:6px;align-items:center}
  .btns{margin:8px 0;display:flex;gap:8px;flex-wrap:wrap}
  button{background:#1a1f2e;color:#fff;border:1px solid #3a4a7a;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .card{margin:10px 0;padding:12px;border:1px solid #333;border-radius:10px;background:#0b0f18}
  .lang{display:flex;gap:8px;margin:6px 0}
  input[type=range]{width:160px}
  small{opacity:.8}
  a {color:#4ac6ff}
</style>
</head>
<body>
<div id="wrap">
  <h2>Meteor Madness: Ants to the Rescue üêú‚òÑÔ∏è</h2>

  <!-- S√©lecteur de langue -->
  <div class="lang">
    <button onclick="setLang('fr')">üá´üá∑ Fran√ßais</button>
    <button onclick="setLang('en')">üá¨üáß English</button>
    <button onclick="setLang('ln')">üá®üá© Ling√°la</button>
  </div>

  <div class="hud">
    <div class="tag"><span id="livesLabel">Vies</span>: <span id="lives">3</span></div>
    <div class="tag"><span id="scoreLabel">Score</span>: <span id="score">0</span></div>
    <div class="tag"><span id="levelLabel">Niveau</span>: <span id="level">1</span></div>
  </div>

  <canvas id="game" width="900" height="560"></canvas>

  <div class="btns">
    <button id="fireBtn">TIR üî¥ (Espace / Tap)</button>
    <button id="shieldBtn">Bouclier üõ°Ô∏è (B)</button>
    <button id="rocketBtn">Fus√©e üöÄ (Sp√©cial)</button>
    <button id="resetBtn">Rejouer ‚Üª</button>
  </div>

  <div class="card" id="fact" hidden></div>

  <!-- Panneau Simulation NASA -->
  <div class="card" id="simPanel">
    <b id="simTitle">Simulation NASA (d√©viation Œîv)</b><br/>
    <div id="simDesc" style="margin:6px 0 10px 0;">
      Teste une strat√©gie d‚Äôimpact cin√©tique (type DART) : une petite variation de vitesse (Œîv) appliqu√©e t√¥t peut √©viter l‚Äôimpact.
    </div>
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center">
      <label>
        <span id="diamLabel">Taille (m)</span> :
        <input type="range" id="diam" min="50" max="800" value="200">
        <span id="diamOut">200</span> m
      </label>
      <label>
        <span id="dvLabel">Œîv (mm/s)</span> :
        <input type="range" id="dv" min="0" max="5" step="0.1" value="1">
        <span id="dvOut">1.0</span> mm/s
      </label>
      <label>
        <span id="tLabel">Temps avant impact</span> :
        <input type="range" id="days" min="5" max="120" step="5" value="30">
        <span id="daysOut">30</span> j
      </label>
      <button id="applyMitigation">Tester la d√©viation</button>
    </div>
    <div id="simOut" style="margin-top:8px"></div>
    <small id="simNote">
      Mod√®le p√©dagogique simplifi√© (niveau Beginner) : d√©viation ‚âà Œîv √ó temps. Des mod√®les plus r√©alistes existent (hors scope 48h).
    </small>
  </div>

  <div class="card" id="controlsCard">
    <b>Contr√¥les : Espace/Tap = Tir ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Fus√©e = Attaque sp√©ciale ‚Ä¢ √âvitez que les ast√©ro√Ødes touchent la Terre !</b>
    <div style="margin-top:6px">
      <a href="https://api.nasa.gov/" target="_blank">NASA APIs</a> ‚Ä¢
      <a href="https://ssd-api.jpl.nasa.gov/doc/cad.html" target="_blank">NEO Close-Approach Data</a>
    </div>
  </div>
</div>

<script>
(() => {
  // ====== I18N ======
  const texts = {
    fr: {
      lives: "Vies", score: "Score", level: "Niveau",
      controls: "Contr√¥les : Espace/Tap = Tir ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Fus√©e = Attaque sp√©ciale ‚Ä¢ √âvitez que les ast√©ro√Ødes touchent la Terre !",
      facts: {
        1: "Apophis passera tr√®s pr√®s de la Terre en 2029.",
        2: "En 2022, la mission DART a d√©vi√© l‚Äôorbite de Dimorphos.",
        3: "OSIRIS-REx a rapport√© des √©chantillons de Bennu en 2023."
      },
      rocketReadyPrefix: "Fus√©e pr√™te dans",
      victory: "Victoire ! Fourmis gardiennes de la Terre üêúüåç",
      gameOver: "Game Over üí•",
      rocketImpact: (n)=>`Impact DART üí• (${n} d√©truit${n>1?'s':''})`,
      simTitle: "Simulation NASA (d√©viation Œîv)",
      simDesc: "Teste une strat√©gie d‚Äôimpact cin√©tique (type DART) : une petite variation de vitesse (Œîv) appliqu√©e t√¥t peut √©viter l‚Äôimpact.",
      diam: "Taille (m)", dv: "Œîv (mm/s)", t: "Temps avant impact",
      simNote: "Mod√®le p√©dagogique simplifi√© (niveau Beginner) : d√©viation ‚âà Œîv √ó temps. Des mod√®les plus r√©alistes existent (hors scope 48h).",
      simResult: (miss, ok)=> `Nouvelle distance de rat√© ‚âà ${miss.toFixed(0)} km ‚Äî ${ok ? "√âVIT√â ‚úÖ" : "TOUCHE ‚ùå"}`
    },
    en: {
      lives: "Lives", score: "Score", level: "Level",
      controls: "Controls: Space/Tap = Fire ‚Ä¢ B = Shield (2s) ‚Ä¢ Rocket = Special attack ‚Ä¢ Don‚Äôt let asteroids hit Earth!",
      facts: {
        1: "Apophis will pass very close to Earth in 2029.",
        2: "In 2022, NASA‚Äôs DART mission changed Dimorphos‚Äô orbit.",
        3: "OSIRIS-REx returned samples from Bennu in 2023."
      },
      rocketReadyPrefix: "Rocket ready in",
      victory: "Victory! Ant Guardians of Earth üêúüåç",
      gameOver: "Game Over üí•",
      rocketImpact: (n)=>`DART impact üí• (${n} destroyed)`,
      simTitle: "NASA Simulation (Œîv deflection)",
      simDesc: "Test a kinetic-impactor strategy (like DART): a small velocity change (Œîv) applied early can avoid impact.",
      diam: "Size (m)", dv: "Œîv (mm/s)", t: "Time to impact",
      simNote: "Educational simplified model (Beginner level): deflection ‚âà Œîv √ó time. More realistic models exist (out of 48h scope).",
      simResult: (miss, ok)=> `New miss distance ‚âà ${miss.toFixed(0)} km ‚Äî ${ok ? "AVOIDED ‚úÖ" : "IMPACT ‚ùå"}`
    },
    ln: {
      lives: "Bomoi", score: "Score", level: "Niveau",
      controls: "Kontrol: Espace/Tap = Kob…õta (TIR) ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Rokete = Atake Sp√©cial ‚Ä¢ Kobatela Mabel√©!",
      facts: {
        1: "Apophis akoleka pene ya Mabel√© na 2029.",
        2: "Na 2022, mission DART ya NASA ebongoli orbit ya Dimorphos.",
        3: "OSIRIS-REx ezongisi sample ya Bennu na 2023."
      },
      rocketReadyPrefix: "Rokete ekoya lisusu na",
      victory: "Elonga! Baf√∫ni ya Mabel√© üêúüåç",
      gameOver: "Game Over üí•",
      rocketImpact: (n)=>`Impact DART üí• (${n} ebebisami)`,
      simTitle: "Simul√°sio NASA (Œîv ya kobengana)",
      simDesc: "Tal√° strat√©gie ya impacteur (DART): soki tobongoli vitesse moke (Œîv) liboso, tokoki kobenga impact.",
      diam: "Bonene (m)", dv: "Œîv (mm/s)", t: "Ntango liboso ya impact",
      simNote: "Modelo ya kelasi: kobengana ‚âà Œîv √ó ntango. Bimisa makasi ezali, kasi liboso te na mikolo 48.",
      simResult: (miss, ok)=> `Distance ya kobeta te ‚âà ${miss.toFixed(0)} km ‚Äî ${ok ? "EBENGAMI ‚úÖ" : "EKOBETA ‚ùå"}`
    }
  };
  let currentLang = "fr";
  function applyLang(){
    const t = texts[currentLang];
    document.getElementById('livesLabel').textContent = t.lives;
    document.getElementById('scoreLabel').textContent = t.score;
    document.getElementById('levelLabel').textContent = t.level;
    document.getElementById('controlsCard').innerHTML =
      `<b>${t.controls}</b>
       <div style="margin-top:6px">
        <a href="https://api.nasa.gov/" target="_blank">NASA APIs</a> ‚Ä¢
        <a href="https://ssd-api.jpl.nasa.gov/doc/cad.html" target="_blank">NEO Close-Approach Data</a>
       </div>`;
    document.getElementById('simTitle').textContent = t.simTitle;
    document.getElementById('simDesc').textContent = t.simDesc;
    document.getElementById('diamLabel').textContent = t.diam;
    document.getElementById('dvLabel').textContent = t.dv;
    document.getElementById('tLabel').textContent = t.t;
    document.getElementById('simNote').textContent = t.simNote;
  }
  function setLang(lang){
    currentLang = texts[lang] ? lang : "fr";
    applyLang();
    const factBox = document.getElementById('fact');
    if (!factBox.hidden) {
      const lvl = parseInt(document.getElementById('level').textContent||"1",10);
      factBox.textContent = texts[currentLang].facts[lvl] || "";
    }
  }
  window.setLang = setLang;

  // ====== NASA NEO API + Fallback ======
  const NEO_FEED_URL = "https://api.nasa.gov/neo/rest/v1/feed";
  const API_KEY = "DEMO_KEY"; // remplace par ta cl√© perso si tu en as une
  const NEO_FALLBACK = [
    { name:"(2024 AB)", diameter_m:120, velocity_kms:18, miss_km:750000, hazardous:false },
    { name:"(2025 CD)", diameter_m:320, velocity_kms:22, miss_km:220000, hazardous:true },
    { name:"(Bennu-like)", diameter_m:490, velocity_kms:12, miss_km:1500000, hazardous:false }
  ];
  let NEO_LIST = [];

  async function fetchNEO(startDate){ // "YYYY-MM-DD"
    const url = `${NEO_FEED_URL}?start_date=${startDate}&api_key=${API_KEY}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error("NEO API error");
    const data = await r.json();
    const list = [];
    for (const day of Object.values(data.near_earth_objects)) {
      for (const o of day) list.push(o);
    }
    return list.map(mapNEOtoGame);
  }

  function mapNEOtoGame(neoObj){
    const d = neoObj?.estimated_diameter?.meters?.estimated_diameter_max ?? 150;
    const approach = neoObj?.close_approach_data?.[0];
    const velocity = approach ? parseFloat(approach.relative_velocity.kilometers_per_second) : 15;
    const miss = approach ? parseFloat(approach.miss_distance.kilometers) : 1000000;
    return {
      name: neoObj?.name || "NEO",
      diameter_m: d,
      velocity_kms: velocity,
      miss_km: miss,
      hazardous: neoObj?.is_potentially_hazardous_asteroid || false
    };
  }

  async function initNEO(){
    try{
      const today = new Date().toISOString().slice(0,10);
      NEO_LIST = await fetchNEO(today);
      if (!NEO_LIST.length) throw new Error("Empty list");
    } catch(e){
      console.warn("API NASA indisponible ‚Üí fallback", e);
      NEO_LIST = NEO_FALLBACK;
    }
  }

  // ====== JEU ======
  const canvas = document.getElementById('game');
  const c = canvas.getContext('2d');
  const uiLives = document.getElementById('lives');
  const uiScore = document.getElementById('score');
  const uiLevel = document.getElementById('level');
  const fact = document.getElementById('fact');

  const W = canvas.width, H = canvas.height;
  const earth = { x: W/2, y: H-50, r: 30 };
  let bullets = [];
  let asteroids = [];
  let lives = 3, score = 0, level = 1;
  let running = true;
  let shield = { active:false, timer:0, cooldown:0 };
  let rocket = { active:false, x:0, y:0, vy:-320, cooldown:0 };
  let lastTime = 0;
  let usedShieldOnce = false;
  let earthAngle = 0;

  function showFact(lvl){
    const txt = (texts[currentLang].facts && texts[currentLang].facts[lvl]) || "";
    fact.textContent = txt;
    fact.hidden = !txt;
    setTimeout(()=>{ fact.hidden = true; }, 3000);
  }
  function showFactText(t){
    fact.textContent = t;
    fact.hidden = false;
    setTimeout(()=>{ fact.hidden = true; }, 4500);
  }

  function reset() {
    lives = 3; score = 0; level = 1;
    bullets = []; asteroids = [];
    shield = { active:false, timer:0, cooldown:0 };
    rocket = { active:false, x:0, y:0, vy:-320, cooldown:0 };
    running = true; lastTime = 0; usedShieldOnce = false;
    uiLives.textContent = lives;
    uiScore.textContent = score;
    uiLevel.textContent = level;
    spawnWave();
    showFact(1);
  }

  function chooseNEOforLevel(level){
    if (!NEO_LIST || !NEO_LIST.length) return null;
    const sorted = [...NEO_LIST].sort((a,b)=> (b.diameter_m*b.velocity_kms) - (a.diameter_m*a.velocity_kms));
    const idx = Math.min(level-1, sorted.length-1);
    return sorted[idx];
  }
  function neoToAsteroid(neo){
    const sizePx = Math.min(34, Math.max(12, neo.diameter_m / 22)); // 12‚Äì34 px
    const hp = neo.diameter_m > 450 ? 4 : neo.diameter_m > 250 ? 3 : neo.diameter_m > 150 ? 2 : 1;
    const speed = 60 + Math.min(110, neo.velocity_kms*2.5); // px/s
    return { r:sizePx, hp, speed, name: neo.name, miss_km: neo.miss_km, velocity_kms: neo.velocity_kms, diameter_m: neo.diameter_m };
  }

  function spawnWave() {
    asteroids = [];
    const neo = chooseNEOforLevel(level);
    if (neo){
      const main = neoToAsteroid(neo);
      asteroids.push({
        x: Math.random()*W, y: -120, ...main
      });
      const debris = level===1?4: level===2?6:8;
      for (let i=0;i<debris;i++){
        asteroids.push({
          x: Math.random()*W, y: -Math.random()*H -40,
          r: 10 + Math.random()*8, hp: 1, speed: 80 + Math.random()*50
        });
      }
      const kmk = (neo.miss_km/1000).toFixed(1);
      showFactText(`${neo.name} ‚Ä¢ ~${neo.diameter_m|0} m ‚Ä¢ ${neo.velocity_kms.toFixed(1)} km/s ‚Ä¢ miss=${kmk}k km`);
    } else {
      // fallback simple
      const count = level === 1 ? 5 : (level === 2 ? 8 : 10);
      for (let i=0;i<count;i++){
        const size = level===1 ? 14 : (level===2 ? 20 : 28);
        const hp = level===1 ? 1 : (level===2 ? 2 : 3);
        asteroids.push({
          x: Math.random()*W, y: -Math.random()*H - 20,
          r: size, hp,
          speed: (level===1? 60: (level===2? 85: 110)) * (0.75 + Math.random()*0.5),
        });
      }
    }
  }

  function fire() {
    if (!running) return;
    bullets.push({ x: earth.x, y: earth.y - earth.r - 6, vy: -560 });
  }
  function activateShield() {
    if (!running) return;
    if (shield.cooldown > 0 || shield.active) return;
    shield.active = true;
    shield.timer = 2.0;
    shield.cooldown = 5.0;
  }
  function launchRocket(){
    if (!running) return;
    if (rocket.active || rocket.cooldown > 0) return;
    rocket.active = true;
    rocket.x = earth.x;
    rocket.y = earth.y - earth.r - 8;
    rocket.cooldown = 8;
  }
  function showBanner(text){
    fact.textContent = text;
    fact.hidden = false;
  }
  function explodeAt(x,y){
    const R = 70;
    let destroyed = 0;
    asteroids = asteroids.filter(a => {
      const dx = a.x - x, dy = a.y - y;
      if (dx*dx + dy*dy <= R*R){
        a.hp -= 3;
        if (a.hp <= 0){ score += 1; destroyed++; return false; }
      }
      return true;
    });
    uiScore.textContent = score;
    const msg = texts[currentLang].rocketImpact
      ? texts[currentLang].rocketImpact(destroyed)
      : `DART impact üí• (${destroyed})`;
    showBanner(msg);
    setTimeout(()=>{ fact.hidden = true; }, 1000);
  }

  document.getElementById('fireBtn').onclick = fire;
  document.getElementById('shieldBtn').onclick = activateShield;
  document.getElementById('rocketBtn').onclick = launchRocket;
  document.getElementById('resetBtn').onclick = reset;
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space') { e.preventDefault(); fire(); }
    if (e.key && e.key.toLowerCase() === 'b') { activateShield(); }
    if (e.key && e.key.toLowerCase() === 'r') { reset(); }
  });
  canvas.addEventListener('pointerdown', fire, {passive:true});

  // ====== Simulation NASA (Œîv) ======
  const diamEl = document.getElementById('diam');
  const dvEl = document.getElementById('dv');
  const daysEl = document.getElementById('days');
  const diamOut = document.getElementById('diamOut');
  const dvOut = document.getElementById('dvOut');
  const daysOut = document.getElementById('daysOut');
  [diamEl,dvEl,daysEl].forEach(el=>{
    el.addEventListener('input', ()=>{
      diamOut.textContent = diamEl.value;
      dvOut.textContent = parseFloat(dvEl.value).toFixed(1);
      daysOut.textContent = daysEl.value;
    });
  });
  function testMitigation(currentNeo){
    const t = texts[currentLang];
    const T = parseInt(daysEl.value,10)*24*3600; // secondes
    const dv_mm_s = parseFloat(dvEl.value);
    const dv_km_s = dv_mm_s / 1e6; // km/s
    const extra_miss_km = dv_km_s * T; // distance gagn√©e (p√©dago)
    const base_miss = currentNeo?.miss_km ?? 0;
    const new_miss = base_miss + extra_miss_km;
    const ok = new_miss > 0;
    document.getElementById('simOut').textContent = t.simResult(new_miss, ok);
  }
  document.getElementById('applyMitigation').onclick = ()=>{
    const neo = chooseNEOforLevel(level) || {miss_km:0};
    // l‚Äôutilisateur peut aussi forcer la taille c√¥t√© ‚Äúinfo‚Äù
    neo.diameter_m = parseFloat(diamEl.value);
    testMitigation(neo);
  };

  // ====== Boucle ======
  function loop(ts){
    if (!lastTime) lastTime = ts;
    let dt = (ts - lastTime) / 1000;
    if (dt <= 0) dt = 1/60;
    if (dt > 0.033) dt = 0.033;
    lastTime = ts;

    update(dt);
    draw();
    if (running) requestAnimationFrame(loop);
  }

  function update(dt){
    earthAngle = (earthAngle + 0.15 * dt) % (Math.PI * 2);

    if (shield.active) {
      shield.timer -= dt;
      if (shield.timer <= 0) shield.active = false;
    } else if (shield.cooldown > 0) {
      shield.cooldown -= dt;
      if (shield.cooldown < 0) shield.cooldown = 0;
    }
    if (rocket.cooldown > 0) { rocket.cooldown -= dt; if (rocket.cooldown < 0) rocket.cooldown = 0; }
    if (rocket.active){
      rocket.y += rocket.vy * dt;
      for (const a of asteroids){
        const dx = a.x - rocket.x, dy = a.y - rocket.y;
        if (dx*dx + dy*dy < (a.r+10)*(a.r+10)){
          explodeAt(rocket.x, rocket.y);
          rocket.active = false;
          break;
        }
      }
      if (rocket.y < -20){ rocket.active = false; }
    }
    for (const b of bullets) {
      if (typeof b.vy !== "number") b.vy = -560;
      b.y += b.vy * dt;
    }
    bullets = bullets.filter(b => b.y > -20);

    for (const a of asteroids) {
      a.y += a.speed * dt;
      for (const b of bullets) {
        const dx = a.x - b.x, dy = a.y - b.y;
        if (dx*dx + dy*dy < (a.r+6)*(a.r+6)) {
          if (level < 3 || usedShieldOnce) { a.hp -= 1; }
          b.y = -9999;
        }
      }
      const dx = a.x - earth.x, dy = a.y - earth.y;
      if (dx*dx + dy*dy < (a.r + earth.r)*(a.r + earth.r)) {
        if (shield.active) { a.y -= 30; a.speed *= 0.6; }
        else { lives -= 1; uiLives.textContent = lives; a.y = H + 50; }
      }
    }

    const before = asteroids.length;
    asteroids = asteroids.filter(a => {
      if (a.hp <= 0) { score += 1; uiScore.textContent = score; return false; }
      return a.y < H + 40;
    });

    if (asteroids.length === 0 && before > 0) {
      if (level < 3) {
        level += 1; uiLevel.textContent = level;
        spawnWave(); showFact(level);
        if (level === 3) usedShieldOnce = false;
      } else {
        running = false;
        showBanner(texts[currentLang].victory);
      }
    }
    if (level === 3 && shield.active) usedShieldOnce = true;

    if (lives <= 0 && running){
      running = false;
      showBanner(texts[currentLang].gameOver);
    }
  }

  function drawStars(){
    c.save();
    for (let i=0;i<100;i++){
      const x = (i*97)%W, y = (i*57)%H;
      c.fillStyle = i%7===0 ? "#99aaff" : "#5560aa";
      c.fillRect(x, y, 2, 2);
    }
    c.restore();
  }
  function drawEarth(){
    const r = earth.r;
    const x = earth.x, y = earth.y;
    c.save(); c.translate(x, y);

    // Halo
    c.beginPath(); c.arc(0,0,r+11,0,Math.PI*2);
    c.strokeStyle = "rgba(120,200,255,0.35)"; c.lineWidth = 9; c.stroke();

    // Oc√©an
    const g = c.createRadialGradient(-r*0.3,-r*0.35,r*0.2, 0,0, r);
    g.addColorStop(0.0, "#17b0ff"); g.addColorStop(0.6, "#0a76c4"); g.addColorStop(1.0, "#06335e");
    c.fillStyle = g; c.beginPath(); c.arc(0,0,r,0,Math.PI*2); c.fill();

    // Continents
    c.rotate(earthAngle); c.fillStyle = "#5ac16b";
    c.beginPath();
    c.moveTo(-r*0.25, -r*0.15);
    c.bezierCurveTo(-r*0.05, -r*0.35,  r*0.25, -r*0.30,  r*0.20, -r*0.05);
    c.bezierCurveTo( r*0.35,  r*0.15,  r*0.10,  r*0.35, -r*0.05,  r*0.25);
    c.bezierCurveTo(-r*0.20,  r*0.15, -r*0.35,  0,     -r*0.25, -r*0.05);
    c.closePath(); c.fill();
    c.beginPath();
    c.moveTo(-r*0.55, 0);
    c.bezierCurveTo(-r*0.65, -r*0.10, -r*0.55,  r*0.20, -r*0.45, r*0.30);
    c.bezierCurveTo(-r*0.35,  r*0.45, -r*0.25,  r*0.35, -r*0.30, r*0.15);
    c.closePath(); c.fill();
    c.beginPath(); c.ellipse(r*0.28, r*0.15, r*0.06, r*0.03, 0, 0, Math.PI*2); c.fill();

    // Nuages
    c.globalAlpha = 0.12; c.strokeStyle="#fff"; c.lineWidth=3;
    for (let i = -1; i <= 1; i++) {
      c.beginPath();
      c.arc(0,0,r*(0.55+i*0.18+0.08*Math.sin(earthAngle*2+i)),-Math.PI*0.2,Math.PI*0.8);
      c.stroke();
    }
    c.globalAlpha = 1;

    c.restore();
    // Motte (base fourmis)
    c.fillStyle = "#6b4a2f"; c.fillRect(x-35, y+r-6, 70, 8);
  }

  function drawNeoArc(){
    // arc illustratif (trajectoire) pour l'ast√©ro√Øde "boss" (hp>1)
    const boss = asteroids.find(a=>a.hp>1);
    if (!boss) return;
    c.save();
    c.strokeStyle = "#4fc3f7"; c.setLineDash([6,4]);
    c.beginPath();
    c.arc(W/2, H+360, 380, -Math.PI*0.95, -Math.PI*0.65);
    c.stroke();
    c.setLineDash([]);
    // L√©gende
    c.fillStyle="#9ad7ff";
    c.fillText(boss.name ? boss.name : "NEO", 12, 34);
    c.restore();
  }

  function draw(){
    c.clearRect(0,0,W,H);
    drawStars();
    drawEarth();

    if (shield.active){
      c.save(); c.strokeStyle = "#58ffa4"; c.lineWidth = 4;
      c.beginPath(); c.arc(earth.x, earth.y, earth.r+12, 0, Math.PI*2); c.stroke(); c.restore();
    }

    c.save(); c.fillStyle = "#ff3b30";
    bullets.forEach(b => { c.fillRect(b.x-3, b.y-10, 6, 12); });
    c.restore();

    if (rocket.active){
      c.save();
      c.fillStyle = "#ffd54d"; c.fillRect(rocket.x-4, rocket.y-10, 8, 20);
      c.fillStyle = "#ff6e40"; c.fillRect(rocket.x-3, rocket.y+10, 6, 8);
      c.restore();
    }
    c.save(); c.fillStyle="#fff";
    const cdText = `${texts[currentLang].rocketReadyPrefix}: ${rocket.cooldown.toFixed(1)}s`;
    c.fillText(cdText, 10, 18);
    c.restore();

    for (const a of asteroids) {
      c.save();
      const g = c.createRadialGradient(a.x-3, a.y-3, 2, a.x, a.y, a.r);
      g.addColorStop(0,"#c7a47a"); g.addColorStop(1,"#6b5136");
      c.fillStyle = g;
      c.beginPath(); c.arc(a.x, a.y, a.r, 0, Math.PI*2); c.fill();
      c.fillStyle = "#fff";
      for (let i=0;i<a.hp;i++){ c.fillRect(a.x- a.r + 4 + i*6, a.y- a.r - 10, 4, 4); }
      c.restore();
    }

    // Orbite/trajectoire illustrative
    drawNeoArc();
  }

  // ====== INIT ======
  applyLang();
  initNEO().then(()=>{ reset(); requestAnimationFrame(loop); });
  // S√©curit√© mobile : tick si RAF throttle
  setInterval(()=>{ if(running){ update(1/60); draw(); } }, 1000/60);
})();
</script>
</body>
</html>
