<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meteor Madness: Ants to the Rescue</title>
<style>
  /* ---- NASA Space Apps Colors ---- */
  :root{
    --electric-blue:#17b0ff;   /* top gradient */
    --deep-blue:#0a1a40;       /* bottom gradient */
    --neon-yellow:#e6ff00;     /* accent only */
    --nasa-red:#FC3D21;
    --white:#FFFFFF;
  }

  /* ---- Fond gradient officiel ---- */
  html,body{
    margin:0;
    height:100%;
    font-family:system-ui,Arial;
    color:var(--white);
    background:linear-gradient(45deg,var(--electric-blue) 0%,var(--deep-blue) 100%);
  }

  #wrap{max-width:900px;margin:0 auto;padding:10px}
  h2{margin:10px 0 6px}

  canvas{
    width:100%;
    height:auto;
    border:2px solid #1e1e1e;
    background:radial-gradient(ellipse at center,#050815 0%,#000 70%);
    border-radius:12px;
    display:block;
  }

  .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .tag{
    background:rgba(0,0,0,0.6);
    border:1px solid #333;border-radius:8px;
    padding:6px 10px;display:flex;gap:6px;align-items:center
  }

  .btns{margin:8px 0;display:flex;gap:8px;flex-wrap:wrap}
  button{
    background:var(--deep-blue);
    color:var(--neon-yellow);
    border:2px solid var(--neon-yellow);
    border-radius:10px;
    padding:10px 14px;
    cursor:pointer;
    font-weight:700;
    text-shadow:0 0 5px rgba(230,255,0,0.6);
  }
  button:hover{background:var(--electric-blue);color:var(--white)}
  button:active{transform:translateY(1px)}

  .card{
    margin:10px 0;padding:12px;
    border:1px solid #333;border-radius:10px;
    background:rgba(10,15,25,0.85)
  }
  .lang{display:flex;gap:8px;margin:6px 0}
  input[type=range]{width:160px}
  small{opacity:.85}
  a{color:var(--electric-blue)}
</style>
</head>
<body>
<div id="wrap">
  <h2>Meteor Madness: Ants to the Rescue üêú‚òÑÔ∏è</h2>

  <!-- Langues -->
  <div class="lang">
    <button onclick="setLang('fr')">üá´üá∑ Fran√ßais</button>
    <button onclick="setLang('en')">üá¨üáß English</button>
    <button onclick="setLang('ln')">üá®üá© Ling√°la</button>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="tag"><span id="livesLabel">Vies</span>: <span id="lives">3</span></div>
    <div class="tag"><span id="scoreLabel">Score</span>: <span id="score">0</span></div>
    <div class="tag"><span id="levelLabel">Niveau</span>: <span id="level">1</span></div>
  </div>

  <!-- Canvas -->
  <canvas id="game" width="900" height="560"></canvas>

  <!-- Boutons -->
  <div class="btns">
    <button id="fireBtn">TIR üî¥ (Espace / Tap)</button>
    <button id="shieldBtn">Bouclier üõ°Ô∏è (B)</button>
    <button id="rocketBtn">Fus√©e üöÄ (Sp√©cial)</button>
    <button id="resetBtn">Rejouer ‚Üª</button>
  </div>

  <!-- Faits/infos -->
  <div class="card" id="fact" hidden></div>

  <!-- Panneau Simulation NASA -->
  <div class="card" id="simPanel">
    <b id="simTitle">Simulation NASA (d√©viation Œîv)</b><br/>
    <div id="simDesc" style="margin:6px 0 10px 0;">
      Teste une strat√©gie d‚Äôimpact cin√©tique (type DART) : une petite variation de vitesse (Œîv) appliqu√©e t√¥t peut √©viter l‚Äôimpact.
    </div>
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center">
      <label>
        <span id="diamLabel">Taille (m)</span> :
        <input type="range" id="diam" min="50" max="800" value="200">
        <span id="diamOut">200</span> m
      </label>
      <label>
        <span id="dvLabel">Œîv (mm/s)</span> :
        <input type="range" id="dv" min="0" max="5" step="0.1" value="1">
        <span id="dvOut">1.0</span> mm/s
      </label>
      <label>
        <span id="tLabel">Temps avant impact</span> :
        <input type="range" id="days" min="5" max="120" step="5" value="30">
        <span id="daysOut">30</span> j
      </label>
      <button id="applyMitigation">Tester la d√©viation</button>
    </div>
    <div id="simOut" style="margin-top:8px"></div>
    <small id="simNote">
      Mod√®le p√©dagogique simplifi√© (niveau Beginner) : d√©viation ‚âà Œîv √ó temps. Des mod√®les plus r√©alistes existent (hors scope 48h).
    </small>
  </div>

  <div class="card" id="controlsCard">
    <b>Contr√¥les : Espace/Tap = Tir ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Fus√©e = Attaque sp√©ciale ‚Ä¢ √âvitez que les ast√©ro√Ødes touchent la Terre !</b>
    <div style="margin-top:6px">
      <a href="https://api.nasa.gov/" target="_blank">NASA APIs</a> ‚Ä¢
      <a href="https://ssd-api.jpl.nasa.gov/doc/cad.html" target="_blank">NEO Close-Approach Data</a>
    </div>
  </div>
</div>

<script>
(() => {
  // ========= I18N =========
  const texts = {
    fr: {
      lives:"Vies", score:"Score", level:"Niveau",
      controls:"Contr√¥les : Espace/Tap = Tir ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Fus√©e = Attaque sp√©ciale ‚Ä¢ √âvitez que les ast√©ro√Ødes touchent la Terre !",
      facts:{1:"Apophis passera tr√®s pr√®s de la Terre en 2029.",2:"En 2022, la mission DART a d√©vi√© l‚Äôorbite de Dimorphos.",3:"OSIRIS-REx a rapport√© des √©chantillons de Bennu en 2023."},
      rocketReadyPrefix:"Fus√©e pr√™te dans",
      victory:"Victoire ! Fourmis gardiennes de la Terre üêúüåç",
      gameOver:"Game Over üí•",
      rocketImpact:(n)=>`Impact DART üí• (${n} d√©truit${n>1?'s':''})`,
      simTitle:"Simulation NASA (d√©viation Œîv)",
      simDesc:"Teste une strat√©gie d‚Äôimpact cin√©tique (type DART) : une petite variation de vitesse (Œîv) appliqu√©e t√¥t peut √©viter l‚Äôimpact.",
      diam:"Taille (m)", dv:"Œîv (mm/s)", t:"Temps avant impact",
      simNote:"Mod√®le p√©dagogique simplifi√© (niveau Beginner) : d√©viation ‚âà Œîv √ó temps. Des mod√®les plus r√©alistes existent (hors scope 48h).",
      simResult:(miss, ok)=> `Nouvelle distance de rat√© ‚âà ${miss.toFixed(0)} km ‚Äî ${ok ? "√âVIT√â ‚úÖ" : "IMPACT ‚ùå"}`,
      impactEnergy:(e)=>`üí• Impact simul√© : √©nergie ‚âà ${e}`
    },
    en: {
      lives:"Lives", score:"Score", level:"Level",
      controls:"Controls: Space/Tap = Fire ‚Ä¢ B = Shield (2s) ‚Ä¢ Rocket = Special attack ‚Ä¢ Don‚Äôt let asteroids hit Earth!",
      facts:{1:"Apophis will pass very close to Earth in 2029.",2:"In 2022, NASA‚Äôs DART mission changed Dimorphos‚Äô orbit.",3:"OSIRIS-REx returned samples from Bennu in 2023."},
      rocketReadyPrefix:"Rocket ready in",
      victory:"Victory! Ant Guardians of Earth üêúüåç",
      gameOver:"Game Over üí•",
      rocketImpact:(n)=>`DART impact üí• (${n} destroyed)`,
      simTitle:"NASA Simulation (Œîv deflection)",
      simDesc:"Test a kinetic-impactor strategy (like DART): a small velocity change (Œîv) applied early can avoid impact.",
      diam:"Size (m)", dv:"Œîv (mm/s)", t:"Time to impact",
      simNote:"Educational simplified model (Beginner level): deflection ‚âà Œîv √ó time. More realistic models exist (out of 48h scope).",
      simResult:(miss, ok)=> `New miss distance ‚âà ${miss.toFixed(0)} km ‚Äî ${ok ? "AVOIDED ‚úÖ" : "IMPACT ‚ùå"}`,
      impactEnergy:(e)=>`üí• Simulated impact: energy ‚âà ${e}`
    },
    ln: {
      lives:"Bomoi", score:"Score", level:"Niveau",
      controls:"Kontrol: Espace/Tap = Kob…õta ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Rokete = Atake Sp√©cial ‚Ä¢ Kobatela Mabel√©!",
      facts:{1:"Apophis akoleka pene ya Mabel√© na 2029.",2:"Na 2022, mission DART ya NASA ebongoli orbit ya Dimorphos.",3:"OSIRIS-REx ezongisi sample ya Bennu na 2023."},
      rocketReadyPrefix:"Rokete ekoya lisusu na",
      victory:"Elonga! Baf√∫ni ya Mabel√© üêúüåç",
      gameOver:"Game Over üí•",
      rocketImpact:(n)=>`Impact DART üí• (${n} ebebisami)`,
      simTitle:"Simul√°sio NASA (Œîv ya kobengana)",
      simDesc:"Tal√° strat√©gie ya impacteur (DART): soki tobongoli vitesse moke (Œîv) liboso, tokoki kobenga impact.",
      diam:"Bonene (m)", dv:"Œîv (mm/s)", t:"Ntango liboso ya impact",
      simNote:"Modelo ya kelasi: kobengana ‚âà Œîv √ó ntango. Bimisa makasi ezali, kasi liboso te na mikolo 48.",
      simResult:(miss, ok)=> `Distance ya kobeta te ‚âà ${miss.toFixed(0)} km ‚Äî ${ok ? "EBENGAMI ‚úÖ" : "EKOBETA ‚ùå"}`,
      impactEnergy:(e)=>`üí• Impact simul√©: makasi ‚âà ${e}`
    }
  };
  let currentLang = "fr";
  function applyLang(){
    const t=texts[currentLang];
    document.getElementById('livesLabel').textContent=t.lives;
    document.getElementById('scoreLabel').textContent=t.score;
    document.getElementById('levelLabel').textContent=t.level;
    document.getElementById('controlsCard').innerHTML=
      `<b>${t.controls}</b>
       <div style="margin-top:6px">
        <a href="https://api.nasa.gov/" target="_blank">NASA APIs</a> ‚Ä¢
        <a href="https://ssd-api.jpl.nasa.gov/doc/cad.html" target="_blank">NEO Close-Approach Data</a>
       </div>`;
    document.getElementById('simTitle').textContent=t.simTitle;
    document.getElementById('simDesc').textContent=t.simDesc;
    document.getElementById('diamLabel').textContent=t.diam;
    document.getElementById('dvLabel').textContent=t.dv;
    document.getElementById('tLabel').textContent=t.t;
    document.getElementById('simNote').textContent=t.simNote;
  }
  function setLang(lang){
    currentLang = texts[lang]?lang:"fr";
    applyLang();
    const factBox=document.getElementById('fact');
    if(!factBox.hidden){
      const lvl=parseInt(document.getElementById('level').textContent||"1",10);
      factBox.textContent=(texts[currentLang].facts||{})[lvl]||"";
    }
  }
  window.setLang=setLang;

  // ========= NASA NEO API + Fallback =========
  const NEO_FEED_URL="https://api.nasa.gov/neo/rest/v1/feed";
  const API_KEY="DEMO_KEY"; // remplace par ta cl√© perso
  const NEO_FALLBACK=[
    {name:"(2024 AB)",diameter_m:120,velocity_kms:18,miss_km:750000,hazardous:false},
    {name:"(2025 CD)",diameter_m:320,velocity_kms:22,miss_km:220000,hazardous:true},
    {name:"(Bennu-like)",diameter_m:490,velocity_kms:12,miss_km:1500000,hazardous:false}
  ];
  let NEO_LIST=[];

  async function fetchNEO(startDate){
    const url=`${NEO_FEED_URL}?start_date=${startDate}&api_key=${API_KEY}`;
    const r=await fetch(url);
    if(!r.ok) throw new Error("NEO API error");
    const data=await r.json(); const list=[];
    for(const day of Object.values(data.near_earth_objects)){ for(const o of day) list.push(o); }
    return list.map(mapNEOtoGame);
  }
  function mapNEOtoGame(neo){
    const d=neo?.estimated_diameter?.meters?.estimated_diameter_max ?? 150;
    const approach=neo?.close_approach_data?.[0];
    const velocity=approach?parseFloat(approach.relative_velocity.kilometers_per_second):15;
    const miss=approach?parseFloat(approach.miss_distance.kilometers):1000000;
    return {name:neo?.name||"NEO",diameter_m:d,velocity_kms:velocity,miss_km:miss,hazardous:neo?.is_potentially_hazardous_asteroid||false};
  }
  async function initNEO(){
    try{
      const today=new Date().toISOString().slice(0,10);
      NEO_LIST=await fetchNEO(today);
      if(!NEO_LIST.length) throw new Error("Empty list");
    }catch(e){
      console.warn("API NASA indisponible ‚Üí fallback",e);
      NEO_LIST=NEO_FALLBACK;
    }
  }

  // ========= Jeu (Canvas) =========
  const canvas=document.getElementById('game');
  const c=canvas.getContext('2d');
  const uiLives=document.getElementById('lives');
  const uiScore=document.getElementById('score');
  const uiLevel=document.getElementById('level');
  const fact=document.getElementById('fact');
  const W=canvas.width, H=canvas.height;

  const earth={x:W/2,y:H-50,r:30};
  let bullets=[], asteroids=[];
  let lives=3, score=0, level=1, running=true;
  let shield={active:false,timer:0,cooldown:0};
  let rocket={active:false,x:0,y:0,vy:-320,cooldown:0};
  let lastTime=0, usedShieldOnce=false, earthAngle=0;

  // explosions anim√©es (particules + flash)
  const explosions=[]; // {x,y,life,max,particles:[{x,y,vx,vy,life}]}
  let screenFlash=0; // alpha 0..1

  function showFactTimed(t, ms=4000){ fact.textContent=t; fact.hidden=false; setTimeout(()=>fact.hidden=true,ms); }
  function showFactLevel(lvl){
    const txt=(texts[currentLang].facts||{})[lvl]||"";
    if(txt) showFactTimed(txt,3000);
  }

  function reset(){
    lives=3;score=0;level=1;bullets=[];asteroids=[];
    running=true;shield={active:false,timer:0,cooldown:0};
    rocket={active:false,x:0,y:0,vy:-320,cooldown:0};
    lastTime=0;usedShieldOnce=false;uiLives.textContent=lives;
    uiScore.textContent=score;uiLevel.textContent=level;
    spawnWave(); showFactLevel(1);
  }

  function chooseNEOforLevel(level){
    if(!NEO_LIST.length) return null;
    const sorted=[...NEO_LIST].sort((a,b)=>(b.diameter_m*b.velocity_kms)-(a.diameter_m*a.velocity_kms));
    return sorted[Math.min(level-1,sorted.length-1)];
  }
  function neoToAsteroid(neo){
    const sizePx=Math.min(34,Math.max(12,neo.diameter_m/22));
    const hp=neo.diameter_m>450?4:neo.diameter_m>250?3:neo.diameter_m>150?2:1;
    const speed=60+Math.min(110,neo.velocity_kms*2.5);
    return {r:sizePx,hp,speed,name:neo.name,miss_km:neo.miss_km,velocity_kms:neo.velocity_kms,diameter_m:neo.diameter_m};
  }

  function spawnWave(){
    asteroids=[];
    const neo=chooseNEOforLevel(level);
    if(neo){
      const main=neoToAsteroid(neo);
      asteroids.push({x:Math.random()*W,y:-120,...main});
      const debris=level===1?4:level===2?6:8;
      for(let i=0;i<debris;i++){
        asteroids.push({x:Math.random()*W,y:-Math.random()*H-40,r:10+Math.random()*8,hp:1,speed:80+Math.random()*50});
      }
      const kmk=(neo.miss_km/1000).toFixed(1);
      showFactTimed(`${neo.name} ‚Ä¢ ~${neo.diameter_m|0} m ‚Ä¢ ${neo.velocity_kms.toFixed(1)} km/s ‚Ä¢ miss=${kmk}k km`,3500);
    }else{
      const count=level===1?5:(level===2?8:10);
      for(let i=0;i<count;i++){
        const size=level===1?14:(level===2?20:28);
        const hp=level===1?1:(level===2?2:3);
        asteroids.push({x:Math.random()*W,y:-Math.random()*H-20,r:size,hp,speed:(level===1?60:(level===2?85:110))*(0.75+Math.random()*0.5)});
      }
    }
  }

  function fire(){ if(!running) return; bullets.push({x:earth.x,y:earth.y-earth.r-6,vy:-560}); }
  function activateShield(){
    if(!running) return;
    if(shield.cooldown>0||shield.active) return;
    shield.active=true;shield.timer=2.0;shield.cooldown=5.0;
  }
  function launchRocket(){
    if(!running) return;
    if(rocket.active||rocket.cooldown>0) return;
    rocket.active=true;rocket.x=earth.x;rocket.y=earth.y-earth.r-8;rocket.cooldown=8;
  }

  // ====== Animations d'impact ======
  function formatEnergyTNT(joules){
    const tnt_per_ton=4.184e9;
    const tons=joules/tnt_per_ton;
    if(tons<1e3) return `${tons.toFixed(0)} t TNT`;
    if(tons<1e6) return `${(tons/1e3).toFixed(1)} kt TNT`;
    return `${(tons/1e6).toFixed(2)} Mt TNT`;
  }
  function estimateImpactEnergyJ(diameter_m, velocity_kms){
    // masse ~ sph√®re roche œÅ=3000 kg/m3
    const r=diameter_m/2;
    const rho=3000;
    const volume=4/3*Math.PI*r*r*r;
    const mass=volume*rho; // kg
    const v=velocity_kms*1000; // m/s
    return 0.5*mass*v*v;
  }

  function spawnExplosion(x,y,power=1){
    const parts=[];
    const count=Math.floor(60*power);
    for(let i=0;i<count;i++){
      const ang=Math.random()*Math.PI*2;
      const sp=(80+120*Math.random())*power;
      parts.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:0,max:0.8+Math.random()*0.6});
    }
    explosions.push({x,y,life:0,max:1.2,particles:parts});
    screenFlash=Math.min(0.7,0.3+0.2*power);
  }

  function updateExplosions(dt){
    for(const e of explosions){
      e.life+=dt;
      for(const p of e.particles){
        p.life+=dt;
        p.x+=p.vx*dt; p.y+=p.vy*dt;
        p.vx*=0.98; p.vy*=0.98; // friction
      }
    }
    // flash decay
    screenFlash=Math.max(0, screenFlash - dt*1.2);
    // remove finished
    for(let i=explosions.length-1;i>=0;i--){
      if(explosions[i].life>explosions[i].max) explosions.splice(i,1);
    }
  }
  function drawExplosions(){
    // flash overlay
    if(screenFlash>0){
      c.save();
      c.globalAlpha=screenFlash*0.6;
      c.fillStyle="#fff";
      c.fillRect(0,0,W,H);
      c.restore();
    }
    // particles + shock rings
    for(const e of explosions){
      const prog=e.life/e.max;
      // shock ring
      c.save();
      c.globalAlpha=Math.max(0,0.5-0.5*prog);
      c.strokeStyle="rgba(255,200,80,0.9)";
      c.lineWidth=2+8*(1-prog);
      c.beginPath();
      c.arc(e.x,e.y, 30+120*prog, 0, Math.PI*2);
      c.stroke();
      c.restore();

      // particles
      for(const p of e.particles){
        const a=Math.max(0,1-p.life/p.max);
        if(a<=0) continue;
        const grd=c.createRadialGradient(p.x,p.y,0,p.x,p.y,6);
        grd.addColorStop(0,"rgba(255,230,120,1)");
        grd.addColorStop(0.5,"rgba(255,120,60,0.9)");
        grd.addColorStop(1,"rgba(255,0,0,0)");
        c.save();
        c.globalAlpha=a;
        c.fillStyle=grd;
        c.beginPath(); c.arc(p.x,p.y,6,0,Math.PI*2); c.fill();
        c.restore();
      }
    }
  }

  // Explosion de la fus√©e (DART)
  function explodeAt(x,y){
    let destroyed=0;
    const R=70;
    asteroids=asteroids.filter(a=>{
      const dx=a.x-x, dy=a.y-y;
      if(dx*dx+dy*dy<=R*R){ a.hp-=3; if(a.hp<=0){ score+=1; destroyed++; return false; } }
      return true;
    });
    uiScore.textContent=score;
    spawnExplosion(x,y,1);
    const msg=(texts[currentLang].rocketImpact?texts[currentLang].rocketImpact(destroyed):`DART impact üí• (${destroyed})`);
    showFactTimed(msg,1200);
  }

  // ====== Entr√©es ======
  document.getElementById('fireBtn').onclick=fire;
  document.getElementById('shieldBtn').onclick=activateShield;
  document.getElementById('rocketBtn').onclick=launchRocket;
  document.getElementById('resetBtn').onclick=reset;
  window.addEventListener('keydown',e=>{
    if(e.code==='Space'){e.preventDefault();fire();}
    if(e.key?.toLowerCase()==='b') activateShield();
    if(e.key?.toLowerCase()==='r') reset();
  });
  canvas.addEventListener('pointerdown',fire,{passive:true});

  // ====== Simulation NASA (Œîv) ======
  const diamEl=document.getElementById('diam');
  const dvEl=document.getElementById('dv');
  const daysEl=document.getElementById('days');
  const diamOut=document.getElementById('diamOut');
  const dvOut=document.getElementById('dvOut');
  const daysOut=document.getElementById('daysOut');
  [diamEl,dvEl,daysEl].forEach(el=>{
    el.addEventListener('input',()=>{
      diamOut.textContent=diamEl.value;
      dvOut.textContent=parseFloat(dvEl.value).toFixed(1);
      daysOut.textContent=daysEl.value;
    });
  });

  function testMitigation(currentNeo){
    const t=texts[currentLang];
    const T=parseInt(daysEl.value,10)*24*3600; // s
    const dv_mm_s=parseFloat(dvEl.value);
    const dv_km_s=dv_mm_s/1e6; // km/s
    const base_miss=currentNeo?.miss_km??0;
    const new_miss=base_miss + dv_km_s*T; // mod√®le √©ducatif
    const ok=new_miss>0;

    // Affichage texte
    document.getElementById('simOut').textContent=t.simResult(new_miss,ok);

    // Si pas √©vit√© ‚Üí explosion p√©dagogique au centre (impact simul√©)
    if(!ok){
      const energyJ=estimateImpactEnergyJ(parseFloat(diamEl.value), currentNeo?.velocity_kms||15);
      const eLabel=formatEnergyTNT(energyJ);
      spawnExplosion(W/2, H/2, 1.1);
      showFactTimed(t.impactEnergy(eLabel), 2500);
    }
  }
  document.getElementById('applyMitigation').onclick=()=>{
    const neo=chooseNEOforLevel(level)||{miss_km:0,velocity_kms:15};
    neo.diameter_m=parseFloat(diamEl.value); // refl√®te le choix curseur
    testMitigation(neo);
  };

  // ====== Boucle ======
  function loop(ts){
    if(!lastTime) lastTime=ts;
    let dt=(ts-lastTime)/1000; if(dt<=0) dt=1/60; if(dt>0.033) dt=0.033;
    lastTime=ts;
    update(dt); draw();
    if(running) requestAnimationFrame(loop);
  }

  function update(dt){
    earthAngle=(earthAngle+0.15*dt)%(Math.PI*2);

    // Timers
    if(shield.active){ shield.timer-=dt; if(shield.timer<=0) shield.active=false; }
    else if(shield.cooldown>0){ shield.cooldown-=dt; if(shield.cooldown<0) shield.cooldown=0; }
    if(rocket.cooldown>0){ rocket.cooldown-=dt; if(rocket.cooldown<0) rocket.cooldown=0; }

    // Rocket
    if(rocket.active){
      rocket.y+=rocket.
