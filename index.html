<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meteor Madness: Ants to the Rescue</title>

<!-- Leaflet (carte) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<style>
  :root{
    --electric-blue:#17b0ff;   /* Space Apps: Electric Blue */
    --deep-blue:#0a1a40;       /* Space Apps: Deep Blue  */
    --neon-yellow:#e6ff00;     /* Accent only (no backgrounds) */
    --nasa-red:#FC3D21;
    --ink:#0b1020;
    --panel:#0c1326ea;
    --text:#ffffff;
  }

  html,body{
    height:100%;
    margin:0;
    color:var(--text);
    font-family:system-ui,Segoe UI,Arial,Helvetica,sans-serif;
    background:linear-gradient(45deg,var(--electric-blue) 0%,var(--deep-blue) 100%);
  }
  #wrap{max-width:1000px;margin:0 auto;padding:12px}
  h1,h2{margin:.4rem 0}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:930px){
    .row{grid-template-columns:1.1fr .9fr}
  }

  /* Banni√®re APOD */
  .apod{
    position:relative;
    border-radius:14px;
    overflow:hidden;
    min-height:160px;
    background:#0c1430;
    border:1px solid #20406a;
  }
  .apod__img{
    width:100%;
    height:220px;
    object-fit:cover;
    display:block;
    filter:saturate(1.05) contrast(1.05);
    background:radial-gradient(ellipse at center,#0a1330 0%,#040819 70%);
  }
  .apod__bar{
    position:absolute;left:0;right:0;bottom:0;
    background:linear-gradient( to top, rgba(0,0,0,.65), rgba(0,0,0,0));
    padding:10px 12px;
    display:flex;justify-content:space-between;gap:10px;align-items:flex-end
  }
  .apod__title{font-weight:700}
  .apod__link{
    background:var(--deep-blue);
    border:2px solid var(--neon-yellow);
    color:var(--neon-yellow);
    font-weight:800;
    padding:6px 10px;border-radius:8px;
    text-decoration:none;
  }

  /* HUD + boutons */
  .hud{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .tag{background:#0b0f1b;border:1px solid #31405f;border-radius:8px;padding:6px 10px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{
    background:var(--deep-blue); color:var(--neon-yellow);
    border:2px solid var(--neon-yellow); border-radius:10px;
    padding:10px 14px; cursor:pointer; font-weight:800;
    text-shadow:0 0 5px rgba(230,255,0,0.45);
  }
  button:hover{background:var(--electric-blue);color:#fff}
  button:active{transform:translateY(1px)}

  /* Cartes / panneaux */
  .card{
    background:var(--panel);
    border:1px solid #2b3b62; border-radius:12px; padding:12px;
  }
  .lang{display:flex;gap:8px;margin:6px 0}
  a{color:#89d8ff}
  small{opacity:.88}

  /* Canvas jeu */
  canvas{
    width:100%; height:auto; display:block;
    background:radial-gradient(ellipse at center,#050815 0%,#000 70%);
    border:1px solid #1e2a4e;border-radius:12px;
  }

  /* Leaflet */
  #map{width:100%;height:400px;border-radius:12px;border:1px solid #243960;overflow:hidden}
  .legend{font-size:.9rem;background:#0b0f1bcc;padding:8px 10px;border-radius:8px;border:1px solid #31405f;color:#fff}
</style>
</head>
<body>
<div id="wrap">

  <h1 id="title">Meteor Madness: Ants to the Rescue üêú‚òÑÔ∏è</h1>

  <!-- LANG -->
  <div class="lang">
    <button onclick="setLang('fr')">üá´üá∑ Fran√ßais</button>
    <button onclick="setLang('en')">üá¨üáß English</button>
    <button onclick="setLang('ln')">üá®üá© Ling√°la</button>
  </div>

  <!-- Banni√®re APOD -->
  <div class="apod" id="apodBox">
    <img id="apodImg" class="apod__img" alt="NASA APOD banner (clickable)"/>
    <div class="apod__bar">
      <div>
        <div class="apod__title" id="apodTitle">Astronomy Picture of the Day</div>
        <small id="apodDate"></small>
      </div>
      <a id="apodLink" class="apod__link" href="#" target="_blank">HD</a>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <!-- Colonne gauche: Jeu -->
    <div>
      <div class="hud">
        <div class="tag"><span id="livesLabel">Vies</span>: <span id="lives">3</span></div>
        <div class="tag"><span id="scoreLabel">Score</span>: <span id="score">0</span></div>
        <div class="tag"><span id="levelLabel">Niveau</span>: <span id="level">1</span></div>
      </div>

      <canvas id="game" width="900" height="560"></canvas>

      <div class="btns" style="margin-top:8px">
        <button id="fireBtn">TIR üî¥ (Espace / Tap)</button>
        <button id="shieldBtn">Bouclier üõ°Ô∏è (B)</button>
        <button id="rocketBtn">Fus√©e üöÄ (Sp√©cial)</button>
        <button id="resetBtn">Rejouer ‚Üª</button>
      </div>

      <div class="card" id="fact" hidden></div>

      <!-- Panneau NASA Œîv -->
      <div class="card" id="simPanel" style="margin-top:10px">
        <b id="simTitle">Simulation NASA (d√©viation Œîv)</b>
        <div id="simDesc" style="margin:6px 0 10px 0;">
          Kinetic impactor (type DART) : petite Œîv appliqu√©e t√¥t = impact √©vit√©.
        </div>
        <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center">
          <label>
            <span id="diamLabel">Taille (m)</span> :
            <input type="range" id="diam" min="50" max="800" value="200">
            <span id="diamOut">200</span> m
          </label>
          <label>
            <span id="dvLabel">Œîv (mm/s)</span> :
            <input type="range" id="dv" min="0" max="5" step="0.1" value="1">
            <span id="dvOut">1.0</span>
          </label>
          <label>
            <span id="tLabel">Temps (jours)</span> :
            <input type="range" id="days" min="5" max="120" step="5" value="30">
            <span id="daysOut">30</span>
          </label>
          <button id="applyMitigation">Tester</button>
        </div>
        <div id="simOut" style="margin-top:8px"></div>
        <small id="simNote">Mod√®le √©ducatif: d√©viation ‚âà Œîv √ó temps.</small>
      </div>
    </div>

    <!-- Colonne droite: Carte impact -->
    <div>
      <div class="card">
        <b id="mapTitle">Carte d‚Äôimpact (clique pour placer le point d‚Äôimpact)</b>
        <div id="map" style="margin-top:8px"></div>
        <small id="mapHint">
          Astuce : clique sur la carte pour simuler un impact. Les cercles montrent ~diam√®tre de crat√®re et port√©e tsunami (si oc√©an).
        </small>
      </div>

      <div class="card" id="controlsCard" style="margin-top:10px">
        <b id="controlsText">Contr√¥les : Espace/Tap = Tir ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Fus√©e = Attaque sp√©ciale ‚Ä¢ √âvitez que les ast√©ro√Ødes touchent la Terre !</b>
        <div style="margin-top:6px">
          <a href="https://api.nasa.gov/" target="_blank">NASA APIs</a> ‚Ä¢
          <a href="https://ssd-api.jpl.nasa.gov/doc/cad.html" target="_blank">NEO Close-Approach Data</a> ‚Ä¢
          <a href="https://www.usgs.gov/" target="_blank">USGS</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   I18N (FR / EN / LN)
========================= */
const texts = {
  fr:{
    title:"Meteor Madness: Ants to the Rescue üêú‚òÑÔ∏è",
    lives:"Vies",score:"Score",level:"Niveau",
    fire:"TIR üî¥ (Espace / Tap)",
    shield:"Bouclier üõ°Ô∏è (B)",
    rocket:"Fus√©e üöÄ (Sp√©cial)",
    reset:"Rejouer ‚Üª",
    controls:"Contr√¥les : Espace/Tap = Tir ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Fus√©e = Attaque sp√©ciale ‚Ä¢ √âvitez que les ast√©ro√Ødes touchent la Terre !",
    facts:{1:"Apophis passera tr√®s pr√®s de la Terre en 2029.",2:"En 2022, DART a d√©vi√© Dimorphos.",3:"OSIRIS-REx a rapport√© des √©chantillons de Bennu en 2023."},
    rocketReadyPrefix:"Fus√©e pr√™te dans",
    victory:"Victoire ! Fourmis gardiennes de la Terre üêúüåç",
    gameOver:"Game Over üí•",
    rocketImpact:n=>`Impact DART üí• (${n} d√©truit${n>1?"s":""})`,
    simTitle:"Simulation NASA (d√©viation Œîv)",
    simDesc:"Kinetic impactor (type DART) : petite Œîv appliqu√©e t√¥t = impact √©vit√©.",
    diam:"Taille (m)",dv:"Œîv (mm/s)",t:"Temps (jours)",
    simNote:"Mod√®le √©ducatif: d√©viation ‚âà Œîv √ó temps.",
    simResult:(miss,ok)=>`Nouvelle distance de rat√© ‚âà ${miss.toFixed(0)} km ‚Äî ${ok?"√âVIT√â ‚úÖ":"IMPACT ‚ùå"}`,
    impactEnergy:e=>`üí• Impact simul√© : √©nergie ‚âà ${e}`,
    mapTitle:"Carte d‚Äôimpact (clique pour placer le point d‚Äôimpact)",
    mapHint:"Astuce : clique sur la carte pour simuler un impact. Les cercles montrent ~diam√®tre de crat√®re et port√©e tsunami (si oc√©an).",
    apodUnavailable:"APOD indisponible ‚Äî mode hors-ligne"
  },
  en:{
    title:"Meteor Madness: Ants to the Rescue üêú‚òÑÔ∏è",
    lives:"Lives",score:"Score",level:"Level",
    fire:"FIRE üî¥ (Space / Tap)",
    shield:"Shield üõ°Ô∏è (B)",
    rocket:"Rocket üöÄ (Special)",
    reset:"Restart ‚Üª",
    controls:"Controls: Space/Tap = Fire ‚Ä¢ B = Shield (2s) ‚Ä¢ Rocket = Special ‚Ä¢ Don‚Äôt let asteroids hit Earth!",
    facts:{1:"Apophis will pass very close to Earth in 2029.",2:"In 2022, NASA‚Äôs DART changed Dimorphos‚Äô orbit.",3:"OSIRIS-REx returned samples from Bennu in 2023."},
    rocketReadyPrefix:"Rocket ready in",
    victory:"Victory! Ant Guardians of Earth üêúüåç",
    gameOver:"Game Over üí•",
    rocketImpact:n=>`DART impact üí• (${n} destroyed)`,
    simTitle:"NASA Simulation (Œîv deflection)",
    simDesc:"Kinetic impactor (DART-like): small early Œîv = avoided impact.",
    diam:"Size (m)",dv:"Œîv (mm/s)",t:"Time (days)",
    simNote:"Educational model: deflection ‚âà Œîv √ó time.",
    simResult:(miss,ok)=>`New miss distance ‚âà ${miss.toFixed(0)} km ‚Äî ${ok?"AVOIDED ‚úÖ":"IMPACT ‚ùå"}`,
    impactEnergy:e=>`üí• Simulated impact: energy ‚âà ${e}`,
    mapTitle:"Impact map (click to place impact)",
    mapHint:"Tip: click the map to simulate an impact. Rings show ~crater diameter and potential tsunami reach (if ocean).",
    apodUnavailable:"APOD unavailable ‚Äî offline mode"
  },
  ln:{
    title:"Meteor Madness: Baf√∫ni na Kobikisa üêú‚òÑÔ∏è",
    lives:"Bomoi",score:"Score",level:"Niveau",
    fire:"KOB∆êTA üî¥ (Espace / Tap)",
    shield:"Bouclier üõ°Ô∏è (B)",
    rocket:"Rokete üöÄ (Sp√©cial)",
    reset:"Kozongela ‚Üª",
    controls:"Kontrol: Espace/Tap = Kob…õta ‚Ä¢ B = Bouclier (2 s) ‚Ä¢ Rokete = Atake Sp√©cial ‚Ä¢ Kobatela Mabel√©!",
    facts:{1:"Apophis akoleka pene na 2029.",2:"Na 2022, DART ebongoli Dimorphos.",3:"OSIRIS-REx ezongisi ba samples ya Bennu na 2023."},
    rocketReadyPrefix:"Rokete ekoya na",
    victory:"Elonga! Baf√∫ni ya Mabel√© üêúüåç",
    gameOver:"Game Over üí•",
    rocketImpact:n=>`Impact DART üí• (${n} ebebisami)`,
    simTitle:"Simul√°sio NASA (Œîv ya kobengana)",
    simDesc:"Impacteur ya DART: Œîv moke liboso = koboya impact.",
    diam:"Bonene (m)",dv:"Œîv (mm/s)",t:"Mikolo",
    simNote:"Modelo ya kelasi: kobengana ‚âà Œîv √ó ntango.",
    simResult:(miss,ok)=>`Distance ya kobeta te ‚âà ${miss.toFixed(0)} km ‚Äî ${ok?"EBENGAMI ‚úÖ":"IMPACT ‚ùå"}`,
    impactEnergy:e=>`üí• Impact simul√©: makasi ‚âà ${e}`,
    mapTitle:"Karte ya impact (koma na esika ya impact)",
    mapHint:"Toli: kanga na karte mpo na simuler impact. Bilingo emonisa ~diam√®tre ya crater mpe port√©e ya tsunami (soki na mbu).",
    apodUnavailable:"APOD ezangi ‚Äî mode offline"
  }
};
let currentLang="fr";
function applyLang(){
  const t=texts[currentLang];
  document.getElementById("title").textContent=t.title;
  document.getElementById("livesLabel").textContent=t.lives;
  document.getElementById("scoreLabel").textContent=t.score;
  document.getElementById("levelLabel").textContent=t.level;
  document.getElementById("fireBtn").textContent=t.fire;
  document.getElementById("shieldBtn").textContent=t.shield;
  document.getElementById("rocketBtn").textContent=t.rocket;
  document.getElementById("resetBtn").textContent=t.reset;
  document.getElementById("controlsText").textContent=t.controls;
  document.getElementById("simTitle").textContent=t.simTitle;
  document.getElementById("simDesc").textContent=t.simDesc;
  document.getElementById("diamLabel").textContent=t.diam;
  document.getElementById("dvLabel").textContent=t.dv;
  document.getElementById("tLabel").textContent=t.t;
  document.getElementById("simNote").textContent=t.simNote;
  document.getElementById("mapTitle").textContent=t.mapTitle;
  document.getElementById("mapHint").textContent=t.mapHint;
}
function setLang(l){ currentLang=texts[l]?l:"fr"; applyLang(); }

/* =========================
   NASA APOD banner (+ fallback)
========================= */
const NASA_KEY="R5ZYBmGm5IzEI3gEcYRgTFRhv97KdRf9laDdcsZj"; // ta cl√©
async function loadAPOD(){
  const img=document.getElementById("apodImg");
  const title=document.getElementById("apodTitle");
  const date=document.getElementById("apodDate");
  const link=document.getElementById("apodLink");
  try{
    const r=await fetch(`https://api.nasa.gov/planetary/apod?api_key=${NASA_KEY}`);
    if(!r.ok) throw new Error("APOD HTTP error");
    const data=await r.json();
    const url=(data.media_type==="image"?data.url:null)||data.hdurl;
    if(!url) throw new Error("no image");
    img.src=url;
    img.alt=data.title||"NASA APOD";
    link.href=data.hdurl||url;
    title.textContent=data.title||"Astronomy Picture of the Day";
    date.textContent=data.date||"";
  }catch(e){
    // Fallback gracieux: visuel simple + texte localis√©
    img.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1600' height='500'>
        <defs>
          <radialGradient id='g' cx='50%' cy='50%'>
            <stop offset='0%' stop-color='#101d4a'/>
            <stop offset='70%' stop-color='#050a1a'/>
          </radialGradient>
        </defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <g fill='#e6ff00' font-family='Arial' font-weight='700' font-size='42'>
          <text x='50' y='80'>NASA APOD</text>
          <text x='50' y='135' fill='#fff' font-size='26'>${texts[currentLang].apodUnavailable}</text>
        </g>
        <g fill='#ffffff'>
          <circle cx='1350' cy='120' r='3'/><circle cx='1200' cy='60' r='2'/><circle cx='1500' cy='220' r='2'/>
        </g>
      </svg>`);
    title.textContent="NASA APOD";
    date.textContent="";
    link.href="#";
  }
}

/* =========================
   Jeu (canvas)
========================= */
const canvas=document.getElementById("game");
const c=canvas.getContext("2d");
const W=canvas.width,H=canvas.height;
const earth={x:W/2,y:H-50,r:30};
let bullets=[], asteroids=[];
let lives=3, score=0, level=1, running=true;
let shield={active:false,timer:0,cooldown:0};
let rocket={active:false,x:0,y:0,vy:-320,cooldown:0};
let lastTime=0, usedShieldOnce=false, earthAngle=0;
const uiLives=document.getElementById("lives");
const uiScore=document.getElementById("score");
const uiLevel=document.getElementById("level");
const fact=document.getElementById("fact");

function showFactTimed(t,ms=3000){ fact.textContent=t; fact.hidden=false; setTimeout(()=>fact.hidden=true,ms); }
function showFactLevel(lvl){
  const t=texts[currentLang].facts?.[lvl]||"";
  if(t) showFactTimed(t,2800);
}
function resetGame(){
  lives=3;score=0;level=1;bullets=[];asteroids=[];
  running=true;shield={active:false,timer:0,cooldown:0};
  rocket={active:false,x:0,y:0,vy:-320,cooldown:0};
  uiLives.textContent=lives;uiScore.textContent=score;uiLevel.textContent=level;
  spawnWave();showFactLevel(1);
}
function spawnWave(){
  asteroids=[];
  const count= level===1?6 : level===2?8:10;
  for(let i=0;i<count;i++){
    const size= level===1?14 : level===2?20:26;
    const hp= level===1?1 : level===2?2:3;
    asteroids.push({
      x:Math.random()*W, y:-Math.random()*H-20, r:size, hp,
      speed:(60+level*20)*(0.75+Math.random()*0.5)
    });
  }
}
function fire(){ if(!running) return; bullets.push({x:earth.x,y:earth.y-earth.r-6,vy:-560}); }
function activateShield(){ if(!running) return; if(shield.cooldown>0||shield.active) return; shield.active=true; shield.timer=2; shield.cooldown=5; }
function launchRocket(){ if(!running) return; if(rocket.active||rocket.cooldown>0) return; rocket.active=true; rocket.x=earth.x; rocket.y=earth.y-earth.r-8; rocket.cooldown=8; }
function explodeAt(x,y){
  let destroyed=0; const R=70;
  asteroids=asteroids.filter(a=>{
    const dx=a.x-x, dy=a.y-y;
    if(dx*dx+dy*dy<=R*R){ a.hp-=3; if(a.hp<=0){ score++; destroyed++; return false; } }
    return true;
  });
  uiScore.textContent=score;
  showFactTimed((texts[currentLang].rocketImpact?.(destroyed))||`DART impact ${destroyed}`,1200);
}
document.getElementById("fireBtn").onclick=fire;
document.getElementById("shieldBtn").onclick=activateShield;
document.getElementById("rocketBtn").onclick=launchRocket;
document.getElementById("resetBtn").onclick=resetGame;
window.addEventListener("keydown",e=>{
  if(e.code==="Space"){e.preventDefault();fire();}
  if(e.key?.toLowerCase()==="b") activateShield();
  if(e.key?.toLowerCase()==="r") resetGame();
});
canvas.addEventListener("pointerdown",fire,{passive:true});

function drawStars(){
  for(let i=0;i<120;i++){
    const x=(i*97)%W, y=(i*57)%H;
    c.fillStyle = i%7===0 ? "#b9caff" : "#6a79c9";
    c.fillRect(x,y,2,2);
  }
}
function drawEarth(){
  const r=earth.r, x=earth.x, y=earth.y;
  c.save(); c.translate(x,y);
  // halo
  c.beginPath(); c.arc(0,0,r+11,0,Math.PI*2);
  c.strokeStyle="rgba(120,200,255,.35)"; c.lineWidth=9; c.stroke();
  // oc√©an
  const g=c.createRadialGradient(-r*.3,-r*.35,r*.2,0,0,r);
  g.addColorStop(0,"#17b0ff"); g.addColorStop(.6,"#0a76c4"); g.addColorStop(1,"#06335e");
  c.fillStyle=g; c.beginPath(); c.arc(0,0,r,0,Math.PI*2); c.fill();
  // continents
  earthAngle=(earthAngle+0.15/60)%(Math.PI*2); c.rotate(earthAngle); c.fillStyle="#5ac16b";
  c.beginPath();
  c.moveTo(-r*.25,-r*.15);
  c.bezierCurveTo(-r*.05,-r*.35,r*.25,-r*.30,r*.20,-r*.05);
  c.bezierCurveTo(r*.35,r*.15,r*.10,r*.35,-r*.05,r*.25);
  c.bezierCurveTo(-r*.20,r*.15,-r*.35,0,-r*.25,-r*.05);
  c.closePath(); c.fill();
  c.restore();
  // base
  c.fillStyle="#6b4a2f"; c.fillRect(x-35,y+r-6,70,8);
}
function update(dt){
  // timers
  if(shield.active){ shield.timer-=dt; if(shield.timer<=0) shield.active=false; }
  else if(shield.cooldown>0){ shield.cooldown-=dt; if(shield.cooldown<0) shield.cooldown=0; }
  if(rocket.cooldown>0){ rocket.cooldown-=dt; if(rocket.cooldown<0) rocket.cooldown=0; }

  if(rocket.active){
    rocket.y+=rocket.vy*dt;
    for(const a of asteroids){
      const dx=a.x-rocket.x, dy=a.y-rocket.y;
      if(dx*dx+dy*dy < (a.r+10)*(a.r+10)){ explodeAt(rocket.x,rocket.y); rocket.active=false; break; }
    }
    if(rocket.y<-20) rocket.active=false;
  }

  for(const b of bullets) b.y += b.vy*dt;
  bullets = bullets.filter(b=>b.y>-20);

  for(const a of asteroids){
    a.y += a.speed*dt;
    // collisions tirs
    for(const b of bullets){
      const dx=a.x-b.x, dy=a.y-b.y;
      if(dx*dx+dy*dy < (a.r+6)*(a.r+6)){ if(level<3||usedShieldOnce) a.hp--; b.y=-9999; }
    }
    // Terre
    const dx=a.x-earth.x, dy=a.y-earth.y;
    if(dx*dx+dy*dy < (a.r+earth.r)*(a.r+earth.r)){
      if(shield.active){ a.y-=30; a.speed*=0.6; }
      else { lives--; uiLives.textContent=lives; a.y=H+50; }
    }
  }
  const before=asteroids.length;
  asteroids=asteroids.filter(a=> (a.hp>0) && (a.y<H+40));
  if(asteroids.length===0 && before>0){
    if(level<3){ level++; uiLevel.textContent=level; spawnWave(); showFactLevel(level); if(level===3) usedShieldOnce=false; }
    else { running=false; showFactTimed(texts[currentLang].victory,3500); }
  }
  if(level===3 && shield.active) usedShieldOnce=true;
  if(lives<=0 && running){ running=false; showFactTimed(texts[currentLang].gameOver,3500); }
}
function draw(){
  c.clearRect(0,0,W,H);
  drawStars(); drawEarth();
  if(shield.active){ c.save(); c.strokeStyle="#58ffa4"; c.lineWidth=4; c.beginPath(); c.arc(earth.x,earth.y,earth.r+12,0,Math.PI*2); c.stroke(); c.restore(); }
  // bullets
  c.save(); c.fillStyle="#ff3b30"; bullets.forEach(b=>c.fillRect(b.x-3,b.y-10,6,12)); c.restore();
  // rocket + cooldown
  if(rocket.active){ c.save(); c.fillStyle="#ffd54d"; c.fillRect(rocket.x-4,rocket.y-10,8,20); c.fillStyle="#ff6e40"; c.fillRect(rocket.x-3,rocket.y+10,6,8); c.restore(); }
  c.save(); c.fillStyle="#fff"; c.fillText(`${texts[currentLang].rocketReadyPrefix}: ${rocket.cooldown.toFixed(1)}s`,10,18); c.restore();
  // asteroids
  for(const a of asteroids){
    const g=c.createRadialGradient(a.x-3,a.y-3,2,a.x,a.y,a.r);
    g.addColorStop(0,"#c7a47a"); g.addColorStop(1,"#6b5136");
    c.fillStyle=g; c.beginPath(); c.arc(a.x,a.y,a.r,0,Math.PI*2); c.fill();
    c.fillStyle="#fff"; for(let i=0;i<a.hp;i++) c.fillRect(a.x-a.r+4+i*6, a.y-a.r-10, 4,4);
  }
}
function loop(ts){
  if(!lastTime) lastTime=ts;
  let dt=(ts-lastTime)/1000; if(dt<=0) dt=1/60; if(dt>0.033) dt=0.033;
  lastTime=ts;
  update(dt); draw();
  if(running) requestAnimationFrame(loop);
}

/* =========================
   Panneau Œîv (texte + impact √©ducatif)
========================= */
const diamEl=document.getElementById("diam");
const dvEl=document.getElementById("dv");
const daysEl=document.getElementById("days");
const diamOut=document.getElementById("diamOut");
const dvOut=document.getElementById("dvOut");
const daysOut=document.getElementById("daysOut");
[diamEl,dvEl,daysEl].forEach(el=>el.addEventListener("input",()=>{
  diamOut.textContent=diamEl.value;
  dvOut.textContent=parseFloat(dvEl.value).toFixed(1);
  daysOut.textContent=daysEl.value;
}));
function formatEnergyTNT(J){
  const tnt=4.184e9; const tons=J/tnt;
  if(tons<1e3) return `${tons.toFixed(0)} t TNT`;
  if(tons<1e6) return `${(tons/1e3).toFixed(1)} kt TNT`;
  return `${(tons/1e6).toFixed(2)} Mt TNT`;
}
function estimateImpactEnergyJ(d_m, v_kms){
  const r=d_m/2, rho=3000, V=4/3*Math.PI*r*r*r, m=V*rho, v=v_kms*1000;
  return 0.5*m*v*v;
}
function testMitigation(){
  const t=texts[currentLang];
  const T=parseInt(daysEl.value,10)*24*3600;
  const dv_km_s=parseFloat(dvEl.value)/1e6;
  const new_miss = dv_km_s * T; // distance gagn√©e (km)
  const ok = new_miss>0;
  document.getElementById("simOut").textContent=t.simResult(new_miss,ok);
  if(!ok){
    const eJ=estimateImpactEnergyJ(parseFloat(diamEl.value),15);
    showFactTimed(t.impactEnergy(formatEnergyTNT(eJ)),2500);
  }
}
document.getElementById("applyMitigation").onclick=testMitigation;

/* =========================
   Carte (Leaflet) + USGS Topo
========================= */
let map, impactMarker, craterCircle, tsunamiCircle;
function initMap(){
  map=L.map('map',{zoomControl:true,worldCopyJump:true}).setView([0,0],2.3);

  // Base OSM
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'¬© OpenStreetMap'
  }).addTo(map);

  // USGS Topo overlay (donn√©es USGS)
  L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19, opacity:0.6, attribution:'USGS Topo'
  }).addTo(map);

  const legend=L.control({position:'topright'});
  legend.onAdd=function(){
    const d=L.DomUtil.create('div','legend');
    d.innerHTML='<b>Legend</b><br>üü¶ Crater (~diam.)<br>üü® Tsunami reach (if ocean)';
    return d;
  };
  legend.addTo(map);

  function placeImpact(latlng){
    const d_m=parseFloat(diamEl.value)||200;
    // heuristique √©ducative pour rayon crat√®re & tsunami
    const crater_km = Math.max(1, d_m/30);
    const tsunami_km = crater_km*12;

    if(impactMarker) map.removeLayer(impactMarker);
    if(craterCircle) map.removeLayer(craterCircle);
    if(tsunamiCircle) map.removeLayer(tsunamiCircle);

    impactMarker=L.marker(latlng).addTo(map)
      .bindPopup(`<b>Impact</b><br>${latlng.lat.toFixed(3)}, ${latlng.lng.toFixed(3)}<br>Crater ‚âà ${crater_km.toFixed(1)} km<br>Tsunami ‚âà ${tsunami_km.toFixed(1)} km (if ocean)`)
      .openPopup();

    craterCircle=L.circle(latlng,{radius:crater_km*1000,color:'#4aa3ff',fillColor:'#4aa3ff',fillOpacity:.15}).addTo(map);
    tsunamiCircle=L.circle(latlng,{radius:tsunami_km*1000,color:'#ffee66',fillColor:'#ffee66',fillOpacity:.08, dashArray:'6,6'}).addTo(map);
  }
  map.on('click',e=>placeImpact(e.latlng));

  // point initial (Golfe de Guin√©e)
  placeImpact({lat:-15,lng:70});
}

/* =========================
   INIT
========================= */
applyLang();
loadAPOD();
resetGame();
requestAnimationFrame(loop);
setInterval(()=>{ if(running){ update(1/60); draw(); } },1000/60); // s√©curit√© mobile
initMap();
</script>
</body>
</html>
